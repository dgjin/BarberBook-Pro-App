# BarberBook Pro 系统深度解析手册

**版本**: 1.5.0
**作者**: 首席架构师
**更新日期**: 2024-03-24

---

## 1. 系统设计思路 (Design Philosophy)

BarberBook Pro 的设计目标是构建一个**高美感、高效率、高透明度**的现代化理发店生态系统。

### 1.1 视觉与交互 (UI/UX)
*   **iOS 风格一致性**: 采用 Apple 的设计语言，大量使用 `ios-blur` (毛玻璃)、`rounded-3xl` (大圆角) 和 `SF Pro/Noto Sans` 字体组合，营造高端沙龙的精致感。
*   **响应式布局**: 针对移动端（顾客/理发师）和大屏端（店内电视/iPad 监控）进行了专门的适配优化。

### 1.2 核心业务逻辑 (Core Business)
*   **实时性优先**: 利用 Supabase 的实时数据库特性，消除传统预约系统中的信息滞后。
*   **理发券闭环**: 将传统会员卡数字化为“理发券”，通过自动核销机制降低人为操作失误，提升财务可追溯性。
*   **AI 深度集成**: 并非简单的对话窗口，AI 扮演着“发型设计专家”和“智能播报员”双重角色。

---

## 2. 功能模块详解

### 2.1 顾客移动端 (Client Portal)
*   **模块功能**:
    *   **多维预约**: 支持按理发师、按日期、按服务项目进行交叉选择。
    *   **实时排位**: 预约成功后，系统根据当前到店签到情况动态计算候补位次。
    *   **AI 发型咨询**: 基于 Google Gemini 3 Flash 模型，结合历史上下文提供个性化建议。
*   **实现方式**:
    *   **状态同步**: 订阅 `app_appointments` 变更，实时更新首页排队概况。
    *   **支付模拟**: 采用原子化事务逻辑，确保时段锁定的准确性。

### 2.2 理发师工作台 (Barber Workbench)
*   **模块功能**:
    *   **数字化排队**: 自动按时间线展示待服务队列。
    *   **智能核销**: 点击“完成服务”时，系统自动判断顾客是否有理发券，若有则执行“扣除券 -> 增加理发师业绩”的连锁反应。
*   **实现方式**:
    *   **QR 签到**: 配合 `qrserver` API，理发师可快速识别顾客凭证。
    *   **财务逻辑**: 在前端逻辑中封装了理发师业绩 `voucher_revenue` 的同步更新。

### 2.3 监控大屏中心 (Web Monitor)
*   **模块功能**:
    *   **视觉展示**: 实时滚动的叫号大屏，包含理发店经典转柱 (Barber Pole) 动画。
    *   **语音叫号 (TTS)**: 配合 Gemini 2.5 Flash TTS，实现自然的人声播报：“请 X 号顾客到 Y 理发师处”。
*   **实现方式**:
    *   **Web Audio API**: 使用 `AudioContext` 播放 Gemini 生成的 raw PCM 音频流。
    *   **轮询与长连接**: 结合 WebSocket 和 5s 心跳轮询，确保在极端网络下依然可靠。

### 2.4 管理员看板与设置 (Admin Dashboard)
*   **模块功能**:
    *   **业绩可视化**: 全年度/全店维度的理发券核销统计看板。
    *   **排班调度**: 基于日历视图的理发师工作日配置。
    *   **审计日志**: 记录包括“取消预约并退券”在内的所有敏感操作。
*   **实现方式**:
    *   **数据聚合**: 使用 SQL 聚合或前端 `useMemo` 计算年度收益占比。
    *   **配置中心**: 将营业时间、服务套餐存储为 JSONB 格式，实现动态扩展。

---

## 3. 技术实现原理 (Technical Implementation)

### 3.1 数据回退机制 (Rollback Logic)
当顾客取消已使用理发券的预约时：
1.  **原子更新**: 更新订单状态为 `cancelled`。
2.  **资产返还**: 将 `app_customers.vouchers` 加一。
3.  **业绩冲正**: 若订单已完成，同步扣除 `app_barbers.voucher_revenue`。
4.  **日志留痕**: 向 `app_logs` 写入包含详细冲正信息的记录。

### 3.2 智能叫号算法
系统通过监听 `status` 从 `confirmed` 变为 `checked_in` 的触发器：
1.  捕获变更事件。
2.  构造文本：“请 ${customer_name} 顾客，到 ${barber_name} 处理发。”
3.  请求 Gemini TTS 获取音频流并立即通过店内音响系统播放。

---

## 4. 总结与展望
BarberBook Pro 实现了从“手工记账”到“智能管理”的飞跃。未来计划引入 **Gemini 3 Pro Image** 实现基于照片的“虚拟试发型”功能，进一步提升顾客体验。