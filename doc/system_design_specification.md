
# BarberBook Pro 系统详细设计说明书 (SDS)

**版本**: 1.5.3  
**状态**: 正式发布  
**更新日期**: 2024-03-26

---

## 1. 系统概述
BarberBook Pro 是一款基于 AI 驱动的高级理发店综合管理系统。本说明书详细阐述系统的核心业务逻辑、数据流转及关键技术实现方案。

---

## 2. 理发券财务系统 (Voucher Financial System)

### 2.1 收入统计逻辑 (Dynamic Aggregation)
系统放弃了传统的静态业绩累计方案，转而采用**实时动态聚合逻辑**，以确保财务数据的绝对真实与一致性。
- **核心逻辑**: 理发师的“累计理发券收入”不再依赖一个可随意修改的数值字段，而是通过查询 `app_appointments` 表中满足以下条件的记录总数计算得出：
  - `barber_name` 匹配目标理发师。
  - `status = 'completed'` (服务已完成)。
  - `used_voucher = true` (该单据确实消耗了理发券)。
- **前端表现**: 在管理后台中，该字段以只读“收益卡片”形式展示。管理员可点击“同步对账”触发重新聚合。

### 2.2 预约取消、退券及业绩冲正机制
系统建立了严密的财务冲正闭环，自动处理异常订单对资产的影响。
- **触发条件**: 客户或管理员将有效预约状态变更为 `cancelled`。
- **退券逻辑**: 若该单据的 `used_voucher` 为 `true`，系统执行原子操作将理发券加回客户账户，并自动修正理发师的动态业绩统计。

---

## 3. 预约单号追踪系统 (Appointment ID Tracking)

### 3.1 唯一标识符定义
- **单号格式**: 系统生成的 `BIGINT` 自增 ID。
- **业务作用**: 
  - **前台核销**: 顾客到店签到时，通过 QR 码包含的 `appt:{id}` 格式进行快速检索。
  - **理发师核对**: 在工作台（Workbench）中，理发师排队序列显著展示 `#{id}` 标签，用于与店内纸质凭证或手机单据快速比对。
  - **审计对账**: 所有财务变动、业绩统计均以此 ID 为唯一检索主键。

---

## 4. 资源排班系统 (Scheduling System)

### 4.1 周排班日历细节
排班模块基于“周循环”模型设计，存储于 `app_barbers.schedule` 数组（0-6 代表周日至周六）。系统在预约界面动态过滤不符合排班时段的请求。

---

## 5. 实时监控与叫号 (Live Monitor)

### 5.1 状态转换与播报触发
监控大屏通过 WebSocket 监听 `UPDATE` 事件。当捕捉到 `checked_in` 状态切换时，提取信息并调用 Gemini 2.5 Flash TTS 接口实现语音播报。
